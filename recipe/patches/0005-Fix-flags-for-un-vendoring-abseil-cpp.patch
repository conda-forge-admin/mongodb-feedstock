From 80e183a9abfa521d0c818c2da7161da2763b53ba Mon Sep 17 00:00:00 2001
From: Nehal J Wani <nehaljw.kkd1@gmail.com>
Date: Mon, 25 May 2020 02:26:17 +0000
Subject: [PATCH 05/17] Fix flags for un-vendoring abseil-cpp

---
 SConstruct                 | 14 ++++++++++++++
 site_scons/libdeps.py      |  2 ++
 src/third_party/SConscript |  3 +--
 3 files changed, 17 insertions(+), 2 deletions(-)

diff --git a/SConstruct b/SConstruct
index 5174942dc0..5fedd76b6a 100644
--- a/SConstruct
+++ b/SConstruct
@@ -4070,6 +4070,20 @@ def doConfigure(myenv):
         conf.env['LIBDEPS_ICUI18N_SYSLIBDEP'] = 'icui18n'
         conf.env['LIBDEPS_ICUUC_SYSLIBDEP'] = 'icuuc'
 
+    if use_system_version_of_library("abseil-cpp"):
+        # Generated using the CMake targets: absl::hashtablez_sampler absl::hash absl::container
+        # Please note that these are in dependency order. Another way is to throw all of these inside
+        # -Wl,--start-group ... -Wl,--end-group
+        conf.env['LIBDEPS_ABSL_LIBS_SYSLIBDEP'] = [
+            'absl_hashtablez_sampler', 'absl_hash', 'absl_wyhash', 'absl_exponential_biased',
+            'absl_synchronization', 'absl_graphcycles_internal', 'absl_stacktrace', 'absl_symbolize',
+            'absl_malloc_internal', 'absl_debugging_internal', 'absl_demangle_internal', 'absl_time',
+            'absl_civil_time', 'absl_time_zone', 'absl_strings', 'absl_base', 'absl_spinlock_wait',
+            'absl_raw_hash_set', 'absl_int128', 'absl_throw_delegate', 'absl_strings_internal',
+            'absl_bad_optional_access', 'absl_bad_variant_access', 'absl_raw_logging_internal',
+            'absl_log_severity', 'absl_city'
+        ]
+
     if wiredtiger and use_system_version_of_library("wiredtiger"):
         if not conf.CheckCXXHeader( "wiredtiger.h" ):
             myenv.ConfError("Cannot find wiredtiger headers")
diff --git a/site_scons/libdeps.py b/site_scons/libdeps.py
index 8dd859222e..a1ee3d4e61 100644
--- a/site_scons/libdeps.py
+++ b/site_scons/libdeps.py
@@ -661,6 +661,8 @@ def make_get_syslibdeps_callable(shared):
 
             setattr(target[0].attributes, Constants.SysLibdepsCached, deps)
 
+        deps = SCons.Util.flatten(deps)
+
         lib_link_prefix = env.subst("$LIBLINKPREFIX")
         lib_link_suffix = env.subst("$LIBLINKSUFFIX")
         # Elements of syslibdeps are either strings (str or unicode), or they're File objects.
diff --git a/src/third_party/SConscript b/src/third_party/SConscript
index c5b2168140..2a16519ad7 100644
--- a/src/third_party/SConscript
+++ b/src/third_party/SConscript
@@ -370,8 +370,7 @@ abseilEnv = env.Clone()
 if use_system_version_of_library("abseil-cpp"):
     abseilEnv = abseilEnv.Clone(
         SYSLIBDEPS=[
-            env['LIBDEPS_ABSL_CONTAINER_SYSLIBDEP'],
-            env['LIBDEPS_ABSL_HASH_SYSLIBDEP'],
+            env['LIBDEPS_ABSL_LIBS_SYSLIBDEP'],
         ])
 else:
     abseilDirectory = 'abseil-cpp-master'
-- 
2.32.0

